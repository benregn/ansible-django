---
- name: install pip requirements
  pip: >
    virtualenv=/home/{{setup.deploy_username}}/.virtualenvs/{{project_name}}
    requirements={{django.root_dir}}/{{django.reqs_path}}/{{settings_module}}.txt
  sudo: False
  tags:
    - deploy

- name: run syncdb
  django_manage: app_path={{django.root}} command=syncdb virtualenv:/home/{{setup.deploy_username}}/.virtualenvs/{{project_name}}
  tags:
    - deploy

- name: run migrations
  django_manage: app_path={{django.root}} command=migrate virtualenv:/home/{{setup.deploy_username}}/.virtualenvs/{{project_name}}
  tags:
    - deploy

- name: "ensure {{project_name}} uwsgi is running"
  supervisorctl: name={{project_name}} state=restarted
  tags:
    - uwsgi

- name: ensure celerybeat is running
  supervisorctl: name=celerybeat state=restarted
  tags:
    - celery

- name: ensure celeryd is running
  supervisorctl: name=celeryd state=restarted
  tags:
    - celery
